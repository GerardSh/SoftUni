# General
## Code First
Миграциите, представляват еволюцията на базата данни и са механизъм, който се използва само при Code First подхода. Постепенно променяме базата, като всяка промяна може да се окаже неподходяща и да се наложи да върнем промените обратно, ако е възможно, особено в етапа на разработка, например, когато клиентът промени изискванията. В момента, в който приложението е в продукция, това е доста рисково.

Еволюцията обикновено върви в посока на развитие, като добавяме нови данни, защото всяко връщане назад може да доведе до загуба на информация. Целта на миграциите е да се минимизират възможните загуби и да се предоставят предупреждения, когато има опасност от загуба на данни.

В обобщение, миграциите са безопасен инструмент за еволюиране на базата данни, който ни позволява да контролираме версиите. В миналото, подобни инструменти са били много скъпи, докато сега можем да ги използваме безплатно, и то с по-добри възможности.
## Database First
При Database First използваме scaffold, който ни позволява да генерираме моделите на базата данни в кода. Еволюцията на модела може да се извършва чрез последователно scaffold-ване и прилагане на необходимите промени. Важно е да се има предвид, че този процес не е част от механизма на миграциите, което води до загуба на проследимост и възможност за връщане назад, освен ако промените не се направят директно в базата данни.
Ако вече имаме база данни и трябва да се съобразим с нея, можем да използваме scaffold, за да създадем DbContext. Препоръчително е след това да създадем initial migration, в която закоментираме всичко в метода `Up()`, пускаме миграцията, за да бъде приложена върху базата данни (дори ако е празна). Така ще се създаде таблицата `__EFMigrationsHistory`, в която ще бъде записана initial migration, но тя няма да бъде приложена върху базата. След това, можем безопасно да продължим да работим с Code First.
Когато искаме да създадем копие на базата някъде другаде, променяме Connection String-а, използваме Update-Database и базата ще бъде изградена с всички направени миграции. Не трябва да забравяме да разкоментираме `Up()` метода, тъй като вече сме изпълнили миграцията, от която сме създали копието.
## How do Migrations Function
![](https://github.com/GerardSh/SoftwareUniversity/blob/main/99%20Attachments/Pasted%20image%2020250304202404.png)

Моделите се променят, когато добавяме нови features или правим други промени, които водят до промяна на базата данни. Това включва добавяне или премахване на нови ентитети и пропъртита.

За да може тези промени да се отразят в модела Code First, имаме нужда от нещо, което да приложи направените промени в кода към самата база данни, в нейната схема. Именно EF Migration е инструментът, който ни позволява да променяме схемата на базата данни, като същевременно поддържа синхрон между релационния и обектно ориентирания модел.

Много от default настройките в EF са направени така, че да не водят до унищожителни промени на базата данни. Системата се старае миграцията да бъде максимално щадяща към данните и да предотврати загубата им. Въпреки това, това не е винаги възможно на 100%, тъй като може да се наложи да премахваме таблици или пропъртита. Въпреки това, EF ни защитава колкото може и ни предупреждава, ако има риск от загуба на данни.
### Model Snapshot
Model Snapshot файла се появява само когато бъде направена първата миграция. Идеята му е да отразява състоянието на базата към текущата миграция. По този файл, EF се ориентира какви са разликите в миграциите.

Последователност на действията, когато изпълним миграция:
- EF сравнява текущия модел с `Model Snapshot` (който отразява последната приложена миграция).
- Генерира се миграционен файл, в който:
    - `Up()` съдържа само разликите (напр. нови таблици, нови колони, промени в типовете и т.н.).
    - `Down()` съдържа инструкциите за връщане на тези промени назад.
- Актуализира се `Model Snapshot`, за да съответства на последното състояние на модела.
- `Update-Database` изпълнява само `Up()` метода на новата миграция, без да изпълнява предишни `Up()` методи.
- EF вече знае как изглежда базата от предходните миграции и прилага само новите промени.
### Migrations Source Files
Те биват проследявани през source control. Принципно веднъж като се генерират, не се променят, освен ако не решим да ги customise-нем.

Веднъж след като имаме създаден миграционния файл, тези промени могат да бъдат отразени в базата данни по няколко начина.
- Можем да използваме EF Core Tools, който прилага миграциите върху базата, като се свързва с нея чрез Connection String-а. EF Core Tools превръща миграционните файлове в SQL заявки и ги изпълнява върху базата. Този вариант е удобен, когато работим през Visual Studio или сме в процес на разработка и прилагаме миграциите, за да можем да тестваме.
- Друг вариант е да генерираме SQL скрипт, който след това ръчно да изпълним върху базата. Това обикновено се използва в среди с автоматизирано разгръщане (Continuous Integration/Continuous Deployment – CI/CD). В този случай се използват генерираните миграции от EF, които инструментът за автоматично разгръщане (без значение кой е той) копира върху сървъра на базата и изпълнява локално. Така миграциите се прилагат върху продукционната база, до която обикновено нямаме директен достъп.
## `EntityFrameworkCore.Tools`
Разпространява се като .NET tool. Microsoft предоставя инструменти, които могат да бъдат извиквани чрез команден ред с .NET и съответния инструмент, който ни е необходим. Другият вариант е да използваме вградената в Visual Studio Package Management Console (PMC). За да я използваме, трябва да инсталираме NuGet пакета **`EntityFrameworkCore.Tools`**.
# Misc
# ChatGPT
## `EnsureCreated()` & `EnsureDeleted()` for Bypassing Migrations
1. **`EnsureDeleted()` + `EnsureCreated()`**
    
    - **Deletes** the existing database and **creates** a new one from scratch.
    - **All data is lost** every time it's run.
    - Bypasses **migrations** completely.
    - Useful for **development/testing**, but **not for production**.
2. **`EnsureCreated()` (without `EnsureDeleted()`)**
    
    - **Creates** the database **only if it doesn’t exist**.
    - **Does NOT update the schema** if changes (new columns/tables) are made.
    - Cannot be used alongside **migrations**—it’s a one-time setup method.
3. **Migrations (`Add-Migration` & `Update-Database`)**
    
    - Applies **incremental changes** to the database schema.
    - **Preserves data** and updates only what’s necessary.
    - Recommended for **production-ready applications**.

✅ Best Practice:

- Use **`EnsureDeleted()` + `EnsureCreated()`** only in **temporary/testing scenarios**.
- Use **migrations** for handling schema changes **without losing data**.
# Bookmarks
Completion: 05.03.2025